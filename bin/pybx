#!/usr/local/anaconda3/bin/python
import ipdb
import sys, os.path
from KVAN import fuargs, topdir
topdir.setup_syspath()
import pybx, pybx_parser

@fuargs.action
def verify(fn):
    pybx.import_pybx(fn, False)
    mod_name = os.path.basename(fn).split(".")[0]
    if not mod_name in globals():
        print(f"can't find module {mod_name}, load failed")
    else:
        print(globals()[mod_name])

@fuargs.action
def parse(fn):
    pybx.import_pybx(fn, False)
    mod_name = os.path.basename(fn).split(".")[0]
    if not mod_name in globals():
        print(f"can't find module {mod_name}, load failed")
        return
    mod = globals()[mod_name]
    mod_defs = pybx_parser.parse_module(mod)
    mod_defs.dump()
            
@fuargs.action
def gen_cpp(fn, out_fn = None):
    out_fd = open(out_fn, "w") if isinstance(out_fn, str) else sys.stdout
    pybx.import_pybx(fn)
    mod_name = os.path.basename(fn).split(".")[0]
    if not mod_name in globals():
        print(f"can't find module {mod_name}, load failed")
        return
    mod = globals()[mod_name]
    mod_defs = codegen.create_module_defs(mod)
    codegen_cpp.generate_cpp_file(module_defs, out_fd)
    return 0

@fuargs.action
def gen_js(fn, out_fn = None):
    out_fd = open(out_fn, "w") if isinstance(out_fn, str) else sys.stdout
    module_defs = codegen.parse_all_modules(fn)
    module_defs.dump()

    codegen_js.generate_js_file(fn, module_defs, out_fd)
    return 0

if __name__ == "__main__":
    fuargs.exec_actions(sys.argv[1:])
    
